<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battle Registration - Portrait Intelligence Labâ„¢</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body id="top">
  <div id="header-placeholder"></div>

  <div class="battle-page">
    <div class="container">
      <div class="card">

        <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--dark);">
          Battle Registration
        </h1>
        <div class="page-disclaimer">
  <strong>Note:</strong>
  Battles are optional discussion exercises intended to encourage critical thinking and
  perspective-sharing. They do not involve rewards, rankings, scoring outcomes,
  assessments, certifications, or guarantees of any kind.
</div>


        

        <!-- ðŸ”„ Loader -->
        <div id="battle-loading" class="text-center">
          <div class="spinner"></div>
          <p style="margin-top:1rem;color:var(--text-light);">
            Checking your battle eligibility...
          </p>
        </div>

        <!-- ðŸš« Not eligible -->
        <div id="eligibility-check" class="hidden">
          <div class="alert alert-warning">
            <strong>Not Eligible:</strong>
            You need Access Pass ($199) or higher to participate in battles.
            <a href="/tier/199" style="margin-left: 1rem; color: var(--primary);">
              View Access Pass
            </a>
          </div>
        </div>

        <!-- ðŸ“ Form (HIDDEN BY DEFAULT) -->
        <form id="battle-form" class="battle-form hidden">
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input
              type="text"
              class="form-input"
              id="battle-name"
              placeholder="Enter your name"
              required
            >
          </div>

          <div class="form-group">
            <label class="form-label">Division</label>
            <div class="division-selector">
              <label class="division-option">
                <input type="radio" name="division" id="div-free">
                <div>Free</div>
              </label>
              <label class="division-option">
                <input type="radio" name="division" id="div-access">
                <div>Access</div>
              </label>
              <label class="division-option">
                <input type="radio" name="division" id="div-elite">
                <div>Elite</div>
              </label>
              <label class="division-option">
                <input type="radio" name="division" id="div-circle">
                <div>Circle</div>
              </label>
            </div>

            <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 0.5rem;">
              Your division will be auto-selected based on your tier.
            </p>
          </div>

          <button type="submit" class="btn btn-primary btn-large btn-block">
            Register for Battle
          </button>

          <a href="/dashboard" class="btn btn-secondary btn-large btn-block mt-3">
            Go to Dashboard
          </a>
        </form>

        <!-- âœ… Success / Already Registered -->
        <div id="success-message" class="hidden">
          <div class="success-message">
            <div class="success-icon">âœ“</div>
            <h2>You're Registered!</h2>
            <p id="success-details" style="font-size: 1.125rem; margin-top: 0.5rem;"></p>
            <p
  style="
    margin-top: 1rem;
    font-size: 1rem;
    color: var(--text-light);
  "
>
  You have been placed in the appropriate division based on your current tier.
</p>

            <div class="action-group-mobile" style="margin-top: 2rem;">
              <a href="/dashboard" class="btn btn-primary btn-large">View Dashboard</a>
              <a href="/" class="btn btn-secondary btn-large">Back to Home</a>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/supabase.js"></script>
  <script src="/js/layout.js"></script>
  <script src="/js/header-auth.js"></script>
  <script src="/js/main.js"></script>

  <script>
    function hideBattleLoader() {
      const loader = document.getElementById("battle-loading");
      if (loader) loader.classList.add("hidden");
    }

    async function loadBattlePage() {
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        hideBattleLoader();
        showNotEligible("Login required to register for battles");
        return;
      }

      const { data: profile, error } = await supabase
        .from("profiles")
        .select("tier, battle_registrations")
        .eq("id", user.id)
        .single();

      if (error || !profile) {
        hideBattleLoader();
        showNotEligible("Unable to verify tier");
        return;
      }

      const userTiers = Array.isArray(profile.tier) ? profile.tier : [profile.tier];
      const eligibleTiers = ["199", "999", "9999"];

      if (!userTiers.some(t => eligibleTiers.includes(t))) {
        hideBattleLoader();
        showNotEligible("You need Access Pass ($199) or higher to participate.");
        return;
      }

      let division = "free";
      if (userTiers.includes("9999")) division = "circle";
      else if (userTiers.includes("999")) division = "elite";
      else if (userTiers.includes("199")) division = "access";

      const DIVISION_TO_TIER = {
        free: "free",
        access: "199",
        elite: "999",
        circle: "9999"
      };

      const currentTierCode = DIVISION_TO_TIER[division];
      const registrations = profile.battle_registrations || [];

      const alreadyRegistered = registrations.some(
        r => r.battle === "current" && r.tier === currentTierCode
      );

      hideBattleLoader();

      if (alreadyRegistered) {
        const successBox = document.getElementById("success-message");
        successBox.classList.remove("hidden");
        successBox.querySelector("h2").textContent = "Already Registered";
        document.getElementById("success-details").textContent =
          `You have already registered for this battle using your ${division.toUpperCase()} tier.`;
        return;
      }

      document.getElementById("battle-form").classList.remove("hidden");

      const radio = document.getElementById(`div-${division}`);
      if (radio) {
        radio.checked = true;
        radio.closest(".division-option").classList.add("selected");
      }

      document.getElementById("battle-form").addEventListener("submit", async e => {
        e.preventDefault();

        const name = document.getElementById("battle-name").value.trim();
        if (!name) return alert("Please enter your name");

        const { data } = await supabase.auth.getSession();
        const token = data.session.access_token;

        const res = await fetch(
          "https://portrait-intelligence-lab-backend.onrender.com/api/battle/register",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ name })
          }
        );

        const result = await res.json();

        if (res.status === 409) {
          alert("You have already registered for this battle with this tier.");
          return;
        }

        if (!res.ok || !result.success) {
          alert(result.message || "Battle registration failed");
          return;
        }

        document.getElementById("battle-form").classList.add("hidden");
        document.getElementById("success-message").classList.remove("hidden");

        document.getElementById("success-details").textContent =
          `Registered successfully in ${result.division.toUpperCase()} division.`;
      });
    }

    function showNotEligible(message) {
      document.getElementById("eligibility-check").classList.remove("hidden");
      document.getElementById("battle-form").classList.add("hidden");

      const strong = document.querySelector("#eligibility-check strong");
      if (strong && strong.nextSibling) {
        strong.nextSibling.textContent = " " + message;
      }
    }

    document.addEventListener("DOMContentLoaded", loadBattlePage);
  </script>
</body>
</html>
