<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Your Pod - Portrait Intelligence Lab™</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="header-placeholder"></div>

    <div class="container">
        <div id="not-member" class="hidden">
            <div class="card">
                <div class="alert alert-warning">
                    <h2 style="margin-bottom: 1rem;">Circle Membership Required</h2>
                    <p>You need to be a member of The Circle to join a pod.</p>
                    <a href="/tier/9999" class="btn btn-primary btn-large mt-3">Learn About The Circle</a>
                </div>
            </div>
        </div>

        <div id="already-assigned" class="hidden">
            <div class="pod-card">
                <h2>Welcome Back</h2>
                <p style="font-size: 1.25rem; margin-bottom: 2rem;">You're already assigned to a pod:</p>
                <div class="pod-name" id="existing-pod-name"></div>
                <a href="/dashboard" class="btn btn-primary btn-large mt-3">Go to Dashboard</a>
            </div>
        </div>

        <div id="assignment-form" class="card">
            <h1 style="font-size: 2.5rem; margin-bottom: 1rem; color: var(--dark);">Join Your Circle Pod</h1>
            <p style="color: var(--text-light); margin-bottom: 2rem;">
                As a Circle member, you'll be assigned to an exclusive pod. Click below to join your pod.
            </p>

            <div style="text-align: center; margin: 3rem 0;">
                <button id="assign-pod-btn" class="btn btn-success btn-large">Join Your Pod</button>
            </div>
        </div>

        <div id="assigned-pod" class="hidden">
            <div class="pod-card">
                <h2>Welcome to Your Pod</h2>
                <p style="font-size: 1.25rem; margin-bottom: 2rem;">You've been assigned to:</p>
                <div class="pod-name" id="pod-name"></div>
                <p style="font-size: 1.125rem; margin-top: 2rem; opacity: 0.9;">
                    Your pod assignment is complete. Connect with your pod members and start collaborating.
                </p>
                <div style="margin-top: 2rem;">
                    <a href="/dashboard" class="btn btn-primary btn-large">Go to Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/js/supabase.js"></script>
<script src="/js/main.js"></script>


<script>
async function loadCirclePod() {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    showNotMember("Login required to join a pod");
    return;
  }

  const { data: profile, error } = await supabase
    .from("profiles")
    .select("tier, pod_id")
    .eq("id", user.id)
    .single();

  if (error || !profile) {
    showNotMember("Unable to verify Circle membership");
    return;
  }

  // ✅ FIX: Standardize to array and check for Circle ID
  const userTiers = Array.isArray(profile.tier) ? profile.tier : [profile.tier];
  const isCircleMember = userTiers.includes("9999");

  if (!isCircleMember) {
    showNotMember("You must be a Circle member to join a pod");
    return;
  }

  // ✅ Circle member verified
  document.getElementById("not-member").classList.add("hidden");
  document.getElementById("assignment-form").classList.remove("hidden");

  // Already has pod
  if (profile.pod_id) {
    document.getElementById("assignment-form").classList.add("hidden");
    document.getElementById("already-assigned").classList.remove("hidden");
    document.getElementById("existing-pod-name").textContent = profile.pod_id;
    return;
  }

  // Join pod
  document.getElementById("assign-pod-btn").addEventListener("click", async () => {
    const session = await supabase.auth.getSession();
    const accessToken = session.data.session.access_token;

    const res = await fetch("/api/circle/pod", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${accessToken}`
      }
    });

    const result = await res.json();

    if (result.success) {
      document.getElementById("assignment-form").classList.add("hidden");
      document.getElementById("assigned-pod").classList.remove("hidden");
      document.getElementById("pod-name").textContent = result.pod;
    } else {
      alert("Failed to join pod");
    }
  });
}

function showNotMember(message) {
  document.getElementById("assignment-form").classList.add("hidden");
  document.getElementById("not-member").classList.remove("hidden");
  // Update the text in the error box
  const alertText = document.querySelector("#not-member p");
  if (alertText) alertText.textContent = message;
}

document.addEventListener("DOMContentLoaded", loadCirclePod);
</script>


     <div id="footer-placeholder"></div>

<script src="/js/layout.js"></script>
<script src="/js/header-auth.js"></script>
</body>
</html>